# å¥—é¤è´­ä¹°å›è°ƒåŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å½“ç”¨æˆ·æˆåŠŸè´­ä¹°å¥—é¤åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. è°ƒç”¨è½¬å‘é¡¹ç›®çš„æ¥å£åˆ›å»º API Key
2. é€šè¿‡é‚®ä»¶å°† API Key å‘é€ç»™ç”¨æˆ·

## æ–‡ä»¶è¯´æ˜

### 1. æ ¸å¿ƒæœåŠ¡æ–‡ä»¶
- **`app/service/packagePurchaseCallback.ts`**
  - å¥—é¤è´­ä¹°æˆåŠŸå›è°ƒæœåŠ¡
  - è´Ÿè´£è°ƒç”¨è½¬å‘é¡¹ç›®æ¥å£åˆ›å»º API Key
  - è´Ÿè´£å‘é€åŒ…å« API Key çš„é‚®ä»¶é€šçŸ¥

### 2. é›†æˆä½ç½®
- **`app/service/orderProcessor.ts`**
  - åœ¨ `handlePaymentSuccess()` å‡½æ•°ä¸­
  - å¥—é¤æ¿€æ´»æˆåŠŸåè‡ªåŠ¨è°ƒç”¨å›è°ƒæœåŠ¡

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

```bash
# è½¬å‘æœåŠ¡çš„åŸºç¡€ URL
FORWARD_API_URL=http://localhost:3000

# å¦‚æœè½¬å‘ API éœ€è¦ç®¡ç†å‘˜è®¤è¯ï¼Œé…ç½®æ­¤ token
# FORWARD_API_ADMIN_TOKEN=your_admin_token_here
```

**æ³¨æ„ï¼š**
- `FORWARD_API_URL` é»˜è®¤ä¸º `http://localhost:3000`
- ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹ä¸ºå®é™…çš„è½¬å‘æœåŠ¡åœ°å€

## è½¬å‘ API æ¥å£è§„èŒƒ

å›è°ƒæœåŠ¡ä¼šè°ƒç”¨ä»¥ä¸‹æ¥å£åˆ›å»º API Keyï¼š

### è¯·æ±‚

```http
POST http://localhost:3000/api/admin/create-apikey
Content-Type: application/json

{
  "userId": "user-uuid",
  "username": "user-name",
  "email": "user@example.com",
  "name": "Auto-generated on package purchase",
  "initialBalance": {
    "packageTokens": 0,
    "independentTokens": 0
  }
}
```

### å“åº”

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "apiKey": "sk-xxxxxxxxxxxx",
  "keyId": "key-id"
}
```

**å¤±è´¥å“åº”ï¼š**
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

## å·¥ä½œæµç¨‹

1. **ç”¨æˆ·è´­ä¹°å¥—é¤** â†’ æ”¯ä»˜æˆåŠŸ
2. **Webhook å›è°ƒ** â†’ `app/api/orders/pay/antom/notify/route.ts`
3. **å¤„ç†æ”¯ä»˜æˆåŠŸ** â†’ `orderProcessor.handlePaymentSuccess()`
4. **æ¿€æ´»å¥—é¤** â†’ `packageManager.purchasePackage()`
5. **âœ¨ æ‰§è¡Œå›è°ƒ** â†’ `packagePurchaseCallback.handlePackagePurchaseCallback()`
   - è·å–ç”¨æˆ·å’Œå¥—é¤ä¿¡æ¯
   - è°ƒç”¨è½¬å‘ API åˆ›å»º API Key
   - å‘é€é‚®ä»¶é€šçŸ¥ç”¨æˆ·
6. **å®Œæˆ** â†’ ç”¨æˆ·æ”¶åˆ°åŒ…å« API Key çš„é‚®ä»¶

## é‚®ä»¶å†…å®¹

é‚®ä»¶åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- âœ… è®¢å•ä¿¡æ¯ï¼ˆè®¢å•å·ã€å¥—é¤åç§°ã€é¢åº¦ã€æœ‰æ•ˆæœŸï¼‰
- ğŸ”‘ è‡ªåŠ¨ç”Ÿæˆçš„ API Key
- âš ï¸ å®‰å…¨æç¤º
- ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—
- ğŸ’» API è°ƒç”¨ç¤ºä¾‹ä»£ç 
- ğŸ”— æ§åˆ¶é¢æ¿é“¾æ¥

## é”™è¯¯å¤„ç†

- å¦‚æœ API Key åˆ›å»ºå¤±è´¥ï¼Œé”™è¯¯ä¼šè¢«è®°å½•åˆ°æ—¥å¿—
- å¦‚æœé‚®ä»¶å‘é€å¤±è´¥ï¼ŒåŒæ ·ä¼šè®°å½•æ—¥å¿—
- **é‡è¦ï¼š** å›è°ƒå¤±è´¥ä¸ä¼šå½±å“è®¢å•çš„æ”¯ä»˜æˆåŠŸçŠ¶æ€
- å¤±è´¥çš„å›è°ƒå¯ä»¥é€šè¿‡åå°ä»»åŠ¡æˆ–æ‰‹åŠ¨é‡è¯•

## æ—¥å¿—è¯´æ˜

ç³»ç»Ÿä¼šè®°å½•ä»¥ä¸‹æ—¥å¿—ï¼š
```
[PackagePurchaseCallback] Processing for user {userId}, package {packageId}, order {orderNo}
[PackagePurchaseCallback] API Key created successfully for user {userId}
[PackagePurchaseCallback] Email sent successfully to {userEmail}
```

é”™è¯¯æ—¥å¿—ï¼š
```
[PackagePurchaseCallback] User not found: {userId}
[PackagePurchaseCallback] Package not found: {packageId}
[PackagePurchaseCallback] Failed to create API key: {error}
[PackagePurchaseCallback] Email sent failed, but API key was created
```

## æµ‹è¯•

### 1. æœ¬åœ°æµ‹è¯•

ç¡®ä¿è½¬å‘é¡¹ç›®è¿è¡Œåœ¨ `http://localhost:3000`ï¼Œç„¶åï¼š

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æ¨¡æ‹Ÿè´­ä¹°å¥—é¤å¹¶è§¦å‘å›è°ƒ
# ï¼ˆé€šè¿‡å®é™…è´­ä¹°æµç¨‹æˆ–ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼‰
```

### 2. æµ‹è¯• API è°ƒç”¨

å¯ä»¥æ‰‹åŠ¨æµ‹è¯•è½¬å‘ APIï¼š

```bash
curl -X POST http://localhost:3000/api/admin/create-apikey \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user-id",
    "username": "testuser",
    "email": "test@example.com",
    "name": "Test API Key"
  }'
```

## ç”Ÿäº§ç¯å¢ƒé…ç½®

1. ä¿®æ”¹ `.env` æ–‡ä»¶ï¼š
   ```bash
   FORWARD_API_URL=https://your-forward-api-domain.com
   # FORWARD_API_ADMIN_TOKEN=your_secure_token
   ```

2. ç¡®ä¿è½¬å‘æœåŠ¡æ¥å£å¯è®¿é—®

3. éªŒè¯ SMTP é‚®ä»¶é…ç½®æ­£ç¡®

## æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**
   - API Key åªåœ¨é‚®ä»¶ä¸­æ˜¾ç¤ºä¸€æ¬¡
   - å»ºè®®è½¬å‘ API æ¥å£éœ€è¦ç®¡ç†å‘˜è®¤è¯
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTPS

2. **å¹‚ç­‰æ€§**
   - å¦‚æœç”¨æˆ·å·²æœ‰ API Keyï¼Œè½¬å‘ API åº”è¿”å›ç°æœ‰çš„
   - æˆ–è€…åœ¨ `packagePurchaseCallback.ts` ä¸­æ·»åŠ æ£€æŸ¥é€»è¾‘

3. **å¼‚æ­¥å¤„ç†**
   - å½“å‰å®ç°æ˜¯åŒæ­¥çš„
   - å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ”¹ä¸ºå¼‚æ­¥é˜Ÿåˆ—å¤„ç†

4. **é‡è¯•æœºåˆ¶**
   - å½“å‰æ²¡æœ‰è‡ªåŠ¨é‡è¯•
   - å¯ä»¥æ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•é€»è¾‘

## æœªæ¥ä¼˜åŒ–

- [ ] æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯• 3 æ¬¡ï¼‰
- [ ] æ”¯æŒå¼‚æ­¥é˜Ÿåˆ—å¤„ç†ï¼ˆé¿å…é˜»å¡æ”¯ä»˜æµç¨‹ï¼‰
- [ ] æ·»åŠ  webhook ç­¾åéªŒè¯ï¼ˆè½¬å‘ API ç«¯ï¼‰
- [ ] è®°å½•å›è°ƒçŠ¶æ€åˆ°æ•°æ®åº“ï¼ˆä¾¿äºè¿½è¸ªå’Œé‡è¯•ï¼‰
- [ ] æ”¯æŒè‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿
- [ ] æ·»åŠ çŸ­ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

## ç›¸å…³æ–‡ä»¶

- `app/service/packagePurchaseCallback.ts` - å›è°ƒæœåŠ¡
- `app/service/orderProcessor.ts` - è®¢å•å¤„ç†å™¨ï¼ˆé›†æˆç‚¹ï¼‰
- `app/api/orders/pay/antom/notify/route.ts` - æ”¯ä»˜ Webhook
- `app/lib/email.js` - é‚®ä»¶æœåŠ¡
- `scripts/create_apikey.js` - å‚è€ƒçš„æµ‹è¯•è„šæœ¬

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æœåŠ¡å™¨æ—¥å¿—
- é‚®ä»¶å‘é€æ—¥å¿—
- è½¬å‘ API æ—¥å¿—
