# 套餐购买回调功能说明

## 功能概述

当用户成功购买套餐后，系统会自动：
1. 调用转发项目的接口创建 API Key
2. 通过邮件将 API Key 发送给用户

## 文件说明

### 1. 核心服务文件
- **`app/service/packagePurchaseCallback.ts`**
  - 套餐购买成功回调服务
  - 负责调用转发项目接口创建 API Key
  - 负责发送包含 API Key 的邮件通知

### 2. 集成位置
- **`app/service/orderProcessor.ts`**
  - 在 `handlePaymentSuccess()` 函数中
  - 套餐激活成功后自动调用回调服务

## 配置说明

### 环境变量配置（.env）

```bash
# 转发服务的基础 URL
FORWARD_API_URL=http://localhost:3000

# 如果转发 API 需要管理员认证，配置此 token
# FORWARD_API_ADMIN_TOKEN=your_admin_token_here
```

**注意：**
- `FORWARD_API_URL` 默认为 `http://localhost:3000`
- 生产环境请修改为实际的转发服务地址

## 转发 API 接口规范

回调服务会调用以下接口创建 API Key：

### 请求

```http
POST http://localhost:3000/api/admin/create-apikey
Content-Type: application/json

{
  "userId": "user-uuid",
  "username": "user-name",
  "email": "user@example.com",
  "name": "Auto-generated on package purchase",
  "initialBalance": {
    "packageTokens": 0,
    "independentTokens": 0
  }
}
```

### 响应

**成功响应：**
```json
{
  "success": true,
  "apiKey": "sk-xxxxxxxxxxxx",
  "keyId": "key-id"
}
```

**失败响应：**
```json
{
  "success": false,
  "error": "错误信息"
}
```

## 工作流程

1. **用户购买套餐** → 支付成功
2. **Webhook 回调** → `app/api/orders/pay/antom/notify/route.ts`
3. **处理支付成功** → `orderProcessor.handlePaymentSuccess()`
4. **激活套餐** → `packageManager.purchasePackage()`
5. **✨ 执行回调** → `packagePurchaseCallback.handlePackagePurchaseCallback()`
   - 获取用户和套餐信息
   - 调用转发 API 创建 API Key
   - 发送邮件通知用户
6. **完成** → 用户收到包含 API Key 的邮件

## 邮件内容

邮件包含以下信息：
- ✅ 订单信息（订单号、套餐名称、额度、有效期）
- 🔑 自动生成的 API Key
- ⚠️ 安全提示
- 🚀 快速开始指南
- 💻 API 调用示例代码
- 🔗 控制面板链接

## 错误处理

- 如果 API Key 创建失败，错误会被记录到日志
- 如果邮件发送失败，同样会记录日志
- **重要：** 回调失败不会影响订单的支付成功状态
- 失败的回调可以通过后台任务或手动重试

## 日志说明

系统会记录以下日志：
```
[PackagePurchaseCallback] Processing for user {userId}, package {packageId}, order {orderNo}
[PackagePurchaseCallback] API Key created successfully for user {userId}
[PackagePurchaseCallback] Email sent successfully to {userEmail}
```

错误日志：
```
[PackagePurchaseCallback] User not found: {userId}
[PackagePurchaseCallback] Package not found: {packageId}
[PackagePurchaseCallback] Failed to create API key: {error}
[PackagePurchaseCallback] Email sent failed, but API key was created
```

## 测试

### 1. 本地测试

确保转发项目运行在 `http://localhost:3000`，然后：

```bash
# 启动开发服务器
npm run dev

# 模拟购买套餐并触发回调
# （通过实际购买流程或使用测试脚本）
```

### 2. 测试 API 调用

可以手动测试转发 API：

```bash
curl -X POST http://localhost:3000/api/admin/create-apikey \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user-id",
    "username": "testuser",
    "email": "test@example.com",
    "name": "Test API Key"
  }'
```

## 生产环境配置

1. 修改 `.env` 文件：
   ```bash
   FORWARD_API_URL=https://your-forward-api-domain.com
   # FORWARD_API_ADMIN_TOKEN=your_secure_token
   ```

2. 确保转发服务接口可访问

3. 验证 SMTP 邮件配置正确

## 注意事项

1. **安全性**
   - API Key 只在邮件中显示一次
   - 建议转发 API 接口需要管理员认证
   - 生产环境使用 HTTPS

2. **幂等性**
   - 如果用户已有 API Key，转发 API 应返回现有的
   - 或者在 `packagePurchaseCallback.ts` 中添加检查逻辑

3. **异步处理**
   - 当前实现是同步的
   - 如果需要，可以改为异步队列处理

4. **重试机制**
   - 当前没有自动重试
   - 可以添加指数退避重试逻辑

## 未来优化

- [ ] 添加重试机制（失败时自动重试 3 次）
- [ ] 支持异步队列处理（避免阻塞支付流程）
- [ ] 添加 webhook 签名验证（转发 API 端）
- [ ] 记录回调状态到数据库（便于追踪和重试）
- [ ] 支持自定义邮件模板
- [ ] 添加短信通知（可选）

## 相关文件

- `app/service/packagePurchaseCallback.ts` - 回调服务
- `app/service/orderProcessor.ts` - 订单处理器（集成点）
- `app/api/orders/pay/antom/notify/route.ts` - 支付 Webhook
- `app/lib/email.js` - 邮件服务
- `scripts/create_apikey.js` - 参考的测试脚本

## 联系支持

如有问题，请查看：
- 服务器日志
- 邮件发送日志
- 转发 API 日志
