# 管理员面板开发计划

## 项目背景

本项目是一个 Claude Code 镜像站的控制台系统，用户登录后可以查看自己的套餐和使用情况。现需要为系统添加管理员功能，使管理员能够管理用户和卡密系统。

## 开发目的

1. **用户管理**：让管理员能够查看和管理所有用户的信息、套餐状态、积分额度
2. **卡密系统**：实现批量生成卡密、管理卡密状态的功能
3. **权限隔离**：确保普通用户和管理员的功能互不干扰
4. **操作便捷**：提供直观的管理界面，提高管理效率

## 功能需求

### 1. 用户管理
- 用户列表展示（分页、搜索、筛选）
- 用户详情查看（基本信息、套餐信息、使用记录）
- 套餐类型管理（修改用户套餐类型）
- 积分额度调整（增加/减少用户积分）
- 订阅时间管理（延长/缩短订阅到期时间）
- 用户状态管理（激活/暂停/注销账户）
- 用户ID检索（通过UUID或邮箱快速查找用户）

### 2. 卡密管理
- 批量生成卡密（指定类型、数量、有效期）
- 卡密列表查看（显示所有卡密及其状态）
- 卡密状态管理（激活/作废/删除）
- 使用记录追踪（查看卡密被谁使用、何时使用）
- 导出功能（导出卡密列表为CSV/Excel）

### 3. 权限系统
- 角色识别（区分普通用户和管理员）
- 访问控制（管理员专属页面和API保护）
- 权限验证（所有管理操作需要验证管理员身份）

## 开发任务分解

### 阶段一：基础架构（第1-2天）
1. **创建开发文档**
   - [x] ADMIN_DEVELOPMENT_PLAN.md - 开发计划文档
   - [ ] ADMIN_API_SPECIFICATION.md - API规范文档

2. **数据库改造**
   - [ ] 修改 users 表结构（添加role、status、plan_type、plan_expired_at字段）
   - [ ] 创建 redemption_codes 表
   - [ ] 执行数据库迁移

### 阶段二：后端开发（第3-4天）
1. **权限系统**
   - [ ] 修改 NextAuth 配置，session包含用户角色
   - [ ] 创建 isAdmin 中间件
   - [ ] 修改登录逻辑，识别管理员账户

2. **API接口开发**
   - [ ] GET /api/admin/users - 获取用户列表
   - [ ] GET /api/admin/users/[uuid] - 获取用户详情
   - [ ] PUT /api/admin/users/[uuid] - 更新用户信息
   - [ ] POST /api/admin/users/[uuid]/credits - 调整用户积分
   - [ ] GET /api/admin/codes - 获取卡密列表
   - [ ] POST /api/admin/codes/generate - 批量生成卡密
   - [ ] PUT /api/admin/codes/[code] - 更新卡密状态
   - [ ] GET /api/admin/stats - 获取统计数据

### 阶段三：前端开发（第5-6天）
1. **侧边栏改造**
   - [ ] 添加管理员菜单项判断逻辑
   - [ ] 创建管理员入口图标和链接

2. **管理员页面开发**
   - [ ] /dashboard/admin - 管理员仪表板主页
   - [ ] /dashboard/admin/users - 用户管理页面
   - [ ] /dashboard/admin/users/[uuid] - 用户详情页面
   - [ ] /dashboard/admin/codes - 卡密管理页面

3. **组件开发**
   - [ ] AdminGuard - 管理员权限守卫组件
   - [ ] UserTable - 用户列表表格组件
   - [ ] UserDetailModal - 用户详情弹窗组件
   - [ ] CreditAdjustForm - 积分调整表单组件
   - [ ] CodeGenerateForm - 卡密生成表单组件
   - [ ] CodeTable - 卡密列表表格组件

### 阶段四：集成测试（第7天）
1. **功能测试**
   - [ ] 测试所有管理员功能
   - [ ] 测试权限隔离
   - [ ] 测试数据准确性

2. **优化完善**
   - [ ] UI/UX优化
   - [ ] 性能优化
   - [ ] 错误处理完善

## 预期交付成果

1. **完整的管理员面板系统**
   - 用户管理功能完整可用
   - 卡密系统正常运行
   - 权限控制严格有效

2. **清晰的文档**
   - API接口文档
   - 数据库设计文档
   - 使用说明文档

3. **稳定的代码**
   - 代码结构清晰
   - 错误处理完善
   - 性能表现良好

## 技术栈

- **前端**：Next.js 14 + TypeScript + React 18 + Bootstrap 5
- **后端**：Next.js API Routes + Prisma ORM
- **数据库**：MySQL
- **认证**：NextAuth.js
- **样式**：Bootstrap 5（计划迁移到 Tailwind CSS）

## 注意事项

1. 所有新增功能都要保持与现有代码风格一致
2. 数据库操作使用 Prisma，保持事务一致性
3. API设计遵循 RESTful 规范
4. 前端组件尽量复用现有组件
5. 保持代码的可维护性和可扩展性

## 时间规划

- 总工期：7个工作日
- 每日进度更新
- 遇到问题及时沟通解决

## 更新记录

- 2024-12-12：创建开发计划文档