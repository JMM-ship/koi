# 推荐计划实现方案与TDD计划

本文档对齐推荐计划（Referral Program）的业务目标、数据与配置、接口与服务、前端改造、测试先行策略与里程碑，确保与当前代码架构（Next.js App Router + NextAuth + Prisma + Wallet/积分流水 + 订单统一处理）低耦合落地。

## 背景与目标
- Dashboard 新增“推荐计划”入口：
  - 介绍如何邀请（复制链接→分享→获得奖励）。
  - 展示我的邀请码、邀请链接、邀请人数、累计奖励。
  - 邀请记录表：邮箱、姓名、注册时间、购买状态、奖励状态。
- 注册页支持可选“邀请码”输入；通过邀请链接自动填充；支持 Google 一键登录（One Tap）场景的归因不丢失。
- 触发规则：被邀请人“任意付费订单”首次发生时，邀请人获得 2000 独立积分、被邀请人获得 1000 独立积分（均可配置）。
- 策略：默认不补发（购买后才绑定邀请码不自动补发，如需补发仅管理员介入手动处理）。

## 术语与约定
- “独立积分”：Wallet.independentTokens；流水表 `credit_transactions` 的 bucket=independent。
- “首次消费”：该用户历史第一次出现订单状态为 paid（任意付费订单）。
- “已发放奖励”判断：存在一条 `credit_transactions.meta.source='referral_reward'` 且 `meta.inviteeId` 为该被邀请用户的流水。

## 配置（集中管理，可调整）
新增文件：`config/referral.config.ts`
- `REFERRAL_COOKIE_NAME = 'referral_code'`
- `REFERRAL_COOKIE_MAX_AGE_DAYS = 30`
- `INVITER_REWARD_POINTS = 2000`
- `INVITEE_REWARD_POINTS = 1000`
- `INVITE_CODE_MIN_LEN = 4`
- `INVITE_CODE_DEFAULT_LEN = 6`
- `INVITE_CODE_CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'`（允许全部 A–Z 与 0–9，大小写不敏感，统一大写）

规则：
- 邀请码长度 ≥4，字符集上面所述（A–Z 与 0–9），大小写不敏感，存储与展示统一大写。
- Cookie 单域名 30 天；`httpOnly`、`sameSite='lax'`，生产启用 `secure`。

## 数据与迁移
复用字段：
- `prisma/schema.prisma: User.inviteCode`
- `prisma/schema.prisma: User.invitedBy`

新增轻量表（记录邀请码修改次数，仅一次）：
```sql
CREATE TABLE IF NOT EXISTS referral_meta (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  invite_code_changes INT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

大小写不敏感唯一约束（PostgreSQL）：
```sql
-- 保障邀请码在逻辑上大小写不敏感唯一
CREATE UNIQUE INDEX IF NOT EXISTS uk_users_invite_code_lower
ON users ((lower(invite_code)));
```

说明：保留原有非唯一索引（如 `idx_invite_code`）用于查询性能；本唯一索引确保邀请码全局唯一（大小写不敏感）。

## 接口与路由
1) 邀请入口：`app/r/[code]/route.ts`
   - GET：校验基本格式→设置 `referral_code` Cookie（30 天）→302 到 `/auth/signin?ref=CODE`。

2) 绑定接口：`app/api/referrals/attach/route.ts`
   - POST（需登录）：如果用户未绑定且请求体或 Cookie 含有效推荐码，则将 `invitedBy` 绑定为邀请人；幂等（已绑定返回已绑定）。
   - 禁止自邀（`invitedBy !== self`）。

3) 汇总接口：`app/api/referrals/summary/route.ts`
   - GET：返回我的邀请码、邀请链接、邀请人数（`User.invitedBy = me` 计数）、累计奖励（按 `credit_transactions.meta.source='referral_reward'` 汇总 points）。

4) 记录接口：`app/api/referrals/invites/route.ts`
   - GET：分页列出我邀请的用户，包含邮箱、昵称、注册时间、购买状态、奖励状态。

响应示例（summary）：
```json
{
  "inviteCode": "AB2CDE",
  "inviteUrl": "https://example.com/r/AB2CDE",
  "invitedCount": 12,
  "totalRewardPoints": 24000
}
```

响应示例（invites）：
```json
{
  "items": [
    {
      "email": "user1@example.com",
      "name": "User 1",
      "registeredAt": "2025-09-01T10:20:30Z",
      "purchaseStatus": "purchased",          // purchased | not_purchased
      "rewardStatus": "rewarded"              // rewarded | purchased_unrewarded | not_purchased | invalid
    }
  ],
  "page": 1,
  "pageSize": 20,
  "total": 12
}
```

## 服务设计（低耦合实现）
新文件：`app/service/referral.ts`
- `ensureUserInviteCode(userId)`：若用户无码或不合规则生成唯一邀请码（默认 6 位），使用大写字符集；冲突重试。
- `validateInviteCodeFormat(code)`：格式校验与大写化；用于用户自定义与入口路由校验。
- `canChangeInviteCode(userId)`：查询 `referral_meta.invite_code_changes < 1`。修改成功时自增并更新时间。
- `setUserInviteCode(userId, code)`：大小写不敏感唯一校验（Prisma where mode: 'insensitive' + DB 唯一索引双重保障）。
- `attachReferralByCode(userId, code)`：绑定 `invitedBy`，禁止自邀；仅在未绑定时允许；幂等。
- `processFirstPurchase(userId, orderNo)`：若该 userId 为被邀请用户，且这是其首次付费且未发放过推荐奖励，那么：
  - 为邀请人增加 `INVITER_REWARD_POINTS` 独立积分；
  - 为被邀请人增加 `INVITEE_REWARD_POINTS` 独立积分；
  - 写入两条积分流水 `type='income'`、`bucket='independent'`，`meta={ source:'referral_reward', inviterId, inviteeId, orderNo }`；
  - 幂等：先查是否存在 `meta.source='referral_reward' AND meta.inviteeId=userId` 的流水。
- `getReferralSummary(userId)`、`listInvitedUsers(userId, page, pageSize)`：返回汇总与列表。

挂载点：
- 注册接口 `app/api/auth/register/route.js` 支持可选接收 `inviteCode`，注册成功后尝试绑定（attach）。
- OAuth/一键登录：客户端登录完成后调用 `/api/referrals/attach`，读取 URL `ref` 或 Cookie 进行补偿绑定。
- 首次消费奖励：在 `app/service/orderProcessor.ts` 的 `handlePaymentSuccess` 成功结算后调用 `processFirstPurchase(order.user_id, orderNo)`。

## 奖励与状态判定
- 购买状态：
  - `purchased`：存在任一订单 `status='paid'`。
  - `not_purchased`：否则。
- 奖励状态：
  - `rewarded`：存在 `credit_transactions.meta.source='referral_reward' AND meta.inviteeId=该用户`。
  - `purchased_unrewarded`：已购买但未找到上述流水（异常待观察）。
  - `not_purchased`：未购买。
  - `invalid`：绑定失败/被解绑等（预留，当前不产生）。
- 默认不补发：若在首次付费后才绑定邀请码，不自动发放奖励；如需补发仅管理员可手工处理（可通过管理员加分与流水备注实现）。

## 前端改造
- Sidebar：在 `components/dashboard/Sidebar.tsx` 新增“Referral Program”项，并在 `app/dashboard/page.tsx` 中接入切页逻辑。
- 新组件：`components/dashboard/ReferralContent.tsx`
  - 说明区（复制邀请链接）。
  - 我的信息：邀请码、邀请链接、邀请人数、累计奖励。
  - 邀请记录表：邮箱、姓名、注册时间、购买状态、奖励状态；分页。
- 注册页：`app/auth/signin/page.tsx`
  - 注册表单添加“邀请码（可选）”；若 URL `?ref=CODE` 或 Cookie 存在，自动填充。
  - 登录成功后在首屏或 Provider 触发一次 `/api/referrals/attach`（用户未绑定且 Cookie 存在时）。
- 设置页（一次性修改邀请码）：在 `ProfileContent` 增加“修改邀请码”区域：
  - 调用 `canChangeInviteCode` 校验是否首次修改；
  - `validateInviteCodeFormat` + 唯一性校验；
  - 成功后更新 `referral_meta.invite_code_changes += 1`。

## 安全与反作弊
- 禁止自邀（`invitedBy !== self`）。
- 绑定仅一次；奖励发放幂等（依赖首次付费判定 + 流水 meta 标记）。
- Cookie：`httpOnly`、`sameSite='lax'`，生产启用 `secure`。
- 审计：邀请码修改、绑定、奖励发放记录详细日志与流水 meta，便于回溯。

## 监控与回滚
- 关键日志：绑定结果、首次消费奖励结果（含 userId、inviterId、inviteeId、orderNo、points）。
- 指标建议：邀请转化率、奖励发放量、异常（purchased_unrewarded）数量。
- 回滚：移除路由与挂载点，不影响订单/钱包；`referral_meta` 与索引可保留。

## TDD 计划（先测后码）
M1 邀请码与绑定（服务单测）
- `tests/service/referral.invite-code.test.ts`
  - 生成邀请码：格式、默认长度、唯一性、并发冲突重试。
  - 自定义邀请码：格式校验、重复冲突、大小写不敏感唯一。
- `tests/service/referral.attach.test.ts`
  - 绑定：有效绑定、重复绑定幂等、无效 code、自邀禁止。
- `tests/service/referral.modify-limit.test.ts`
  - 一次性修改：首次允许、二次拒绝；`referral_meta` 自增。

M2 入口路由与绑定接口（接口测）
- `/r/[code]`：设置 Cookie 与重定向；不合法 code 拒绝。
- `/api/referrals/attach`：登录后绑定成功；重复调用幂等；无 Cookie/无 code 不更改。

M3 首次消费奖励（集成测）
- `tests/integration/referral.first-purchase.e2e.test.ts`
  - 被邀请人首次付费 → 邀请人与被邀请人积分与流水正确；二次支付不重复发放；幂等验证。

M4 汇总与列表（接口测）
- `/api/referrals/summary`、`/api/referrals/invites`：统计正确、分页正确、状态判定正确。

M5 前端（组件测）
- `ReferralContent` 在 mock API 下渲染数据与交互（复制按钮、分页）。
- 注册页邀请码输入、URL/Cookie 自动填充、登录后自动绑定一次。

## 里程碑与交付
- M1 配置与服务（含 `referral_meta` 与唯一索引 SQL 文档 + 测试用例）
- M2 入口路由与绑定 API（含测试）
- M3 首次消费奖励挂载到 `handlePaymentSuccess`（含测试）
- M4 Summary/List API（含测试）
- M5 前端页面与 Sidebar、注册页改造（组件测试）
- M6 管理员改码接口/面板增强（可选）
- M7 文档完善与验收

## 验收标准
- 被邀请人“任意首次付费”触发一次性双向奖励；积分与流水准确；重复订单不再发放。
- 邀请码默认生成与“一次性修改”规则生效；大小写不敏感唯一约束有效。
- 邀请链接/邀请码两条路径均可完成绑定；One Tap 登录不丢失归因。
- Dashboard 汇总与记录准确、前端样式与现有统一。

## 风险与边界
- 用户在首次付费后才绑定邀请码：默认不补发（仅管理员可手动奖励）。
- 用户修改邀请码后旧链接失效：不做旧码映射（如需可后续扩展映射表）。

---
本文档对齐后，将按里程碑“测试先行”推进，逐步提交测试与实现，确保每一步可独立验证与回退。

## 当前进度（TDD）与结果

已完成（M1 ~ M5）：
- 配置与迁移
  - 新增配置：`config/referral.config.ts`
  - 迁移脚本（文档）：`prisma/referral_meta.migration.sql`（`referral_meta` 表 + 大小写不敏感唯一索引 `uk_users_invite_code_lower`）
- 服务与逻辑
  - `app/service/referral.ts`：
    - 邀请码校验与生成：`validateInviteCodeFormat`、`generateInviteCode`
    - 创建/设置邀请码（一次性修改限制 + 唯一性校验）：`ensureUserInviteCode`、`setUserInviteCode`、`canChangeInviteCode`
    - 绑定：`attachReferralByCode`（禁止自邀、幂等）
    - 首次消费奖励：`processFirstPurchase`（被邀请人第一笔已付订单触发，邀请人/被邀请人分别发放独立积分并写入流水，幂等）
  - 订单成功回调挂载：`app/service/orderProcessor.ts#handlePaymentSuccess` 调用 `processFirstPurchase`
- API 与路由
  - 邀请入口：`app/r/[code]/route.ts`（设置 Cookie 并跳转到登录）
  - 绑定接口：`app/api/referrals/attach/route.ts`
  - 汇总接口：`app/api/referrals/summary/route.ts`
  - 列表接口：`app/api/referrals/invites/route.ts`
- 前端与交互（M5）
  - Dashboard 页面与导航：
    - 新增 `components/dashboard/ReferralContent.tsx`（展示邀请码/邀请链接/邀请人数/累计奖励、邀请记录分页、复制链接）
    - `components/dashboard/Sidebar.tsx` 增加入口 “Referral Program”
    - `app/dashboard/page.tsx` 接入 `referral` 选项卡
  - 注册与登录粘合：
    - `app/auth/signin/page.tsx` 新增“Invite Code (Optional)”输入，从 URL `?ref=` 自动填充，并在注册/Google 登陆前将邀请码持久化到 `localStorage('inviteCode')`
    - `app/providers.tsx` 登录后全局触发一次 `/api/referrals/attach`（优先 body.code=localStorage，其次由后端读取 httpOnly Cookie），幂等
- 测试（均已通过）
  - 服务层：
    - `tests/service/referral.invite-code.test.ts`
    - `tests/service/referral.attach.test.ts`
    - `tests/service/referral.modify-limit.test.ts`
  - 集成：
    - `tests/integration/referral.first-purchase.e2e.test.ts`（首次付费奖励 + 二次购买不重复发放）
  - API：
    - `tests/api/referrals.entry.route.test.ts`（邀请入口）
    - `tests/api/referrals.attach.route.test.ts`（绑定接口）
    - `tests/api/referrals.summary.route.test.ts`（汇总）
    - `tests/api/referrals.invites.route.test.ts`（列表）
  - 前端组件：
    - `tests/components/ReferralContent.test.tsx`（页面数据渲染、复制链接、分页）
    - `tests/components/DashboardSidebar.referral.test.tsx`（Sidebar 新入口渲染与切换）
    - `tests/components/Providers.attach-referral.test.tsx`（登录后自动绑定，一次性触发与本地清理）
    - `tests/pages/signin.invite-input.test.tsx`（注册页 URL `?ref=` 自动填充与持久化）

测试运行指引：
- 环境变量：`.env` 已增加
  - `NEXT_PUBLIC_SITE_URL=http://localhost:3000`
  - `TEST_DATABASE_URL`、`TEST_DIRECT_URL`（优先用于 Jest，建议指向测试库直连 5432）
- 命令：
  - 全量：`npx jest --runInBand`
  - 服务层：`npx jest tests/service/referral.*.test.ts --runInBand`
  - 集成：`npx jest tests/integration/referral.first-purchase.e2e.test.ts --runInBand`
  - API：`npx jest "tests/api/referrals.*.test.ts" --runInBand`
  - 前端组件：
    - `npx jest tests/components/ReferralContent.test.tsx --runInBand`
    - `npx jest tests/components/DashboardSidebar.referral.test.tsx --runInBand`
    - `npx jest tests/components/Providers.attach-referral.test.tsx --runInBand`
    - `npx jest tests/pages/signin.invite-input.test.tsx --runInBand`
  - 依赖：前端测试需安装 `jest-environment-jsdom`

稳定性说明：
- 远程数据库偶发延迟可能导致事务超时/连接失败，已通过以下方式缓解：
  - Jest 优先使用 `TEST_DATABASE_URL/TEST_DIRECT_URL` 的直连（5432）
  - `setUserInviteCode` 的 Prisma 事务已提升超时：`{ maxWait: 15000, timeout: 15000 }`
- 如仍偶发，请重跑或进一步提高超时，或在网络更稳定环境运行。

上线前操作（DB 统一迁移）：
- 生产/预发需执行 `prisma/referral_meta.migration.sql`：
  - 创建 `referral_meta` 表（记录邀请码修改次数）
  - 添加唯一索引 `uk_users_invite_code_lower`（users.invite_code 大小写不敏感唯一）
- 环境变量：确保 `NEXT_PUBLIC_SITE_URL` 配置为线上域名。

## 交接说明（后续工作）

待办（M6 及以后）：
- 管理能力（可选扩展）
  - 管理员二次修改邀请码（超出一次的用户修改请求由管理员完成）
  - 后台查看邀请与奖励流水审计、风控与反作弊（同 IP/设备聚类等）
- 工程化与增强
  - 将 `referral_meta` 纳入 Prisma schema（如需强类型与迁移接管）
  - 给 `/api/referrals/attach` 增加速率限制与告警
  - 前端空态/加载反饋与细节打磨（已具备基础能力，可视需求优化）
  - 退款回滚策略（如后续要求补充）

重要注意：
- 默认策略：“首次消费定义”为任意付费订单；“事后绑定不补发”。
- 奖励积分为配置项（邀请人 2000，被邀请人 1000），集中在 `config/referral.config.ts`。
- 邀请码规范：`A–Z` 与 `0–9`，长度 ≥4，统一大写；一次性修改限制由 `referral_meta` 记录。
 - One Tap 不丢失推荐码：通过 URL `?ref=` → `localStorage('inviteCode')` → 登录后全局 `/api/referrals/attach` 补偿绑定（优先 body.code，其次后端读 httpOnly Cookie）。

负责人交接：
- 代码位置与关键文件见上；测试用例覆盖核心路径，可作为回归保障。
- 若需验证端到端流转：建议先跑 API 与集成用例，再对接前端页面。
- 生产迁移与环境变量需上线前统一执行与校验。
