# 用户购买套餐测试用例

## 测试概述
本测试用例验证用户购买套餐的完整流程，包括数据库表的正确更新、Dashboard页面的显示变化，以及相关业务逻辑的正确执行。

## 测试前置条件
- 用户已完成注册和登录
- 系统中存在可用的套餐（Package表中有isActive=true的记录）
- 用户钱包（Wallet）已初始化

## 测试场景1: 用户首次购买套餐

### 1.1 测试数据准备
```sql
-- 测试用户信息
用户ID: test-user-123
邮箱: testuser@example.com

-- 测试套餐信息
套餐ID: package-basic-001
套餐名称: "基础版"
价格: 2900分（29.00元）
每日积分: 10000
有效天数: 30
套餐类型: "basic"
```

### 1.2 测试步骤
1. **用户访问套餐页面** (`/dashboard?section=plans`)
   - 验证页面显示所有可用套餐
   - 验证套餐价格、特性等信息正确显示

2. **用户选择套餐并点击"Choose Plan"**
   - 触发 `handlePurchase()` 函数
   - 弹出确认购买模态框

3. **用户确认购买**
   - 调用 `/api/orders/create` 接口创建订单
   - 调用 `/api/orders/pay/mock` 模拟支付成功

### 1.3 预期结果验证

#### 3.1 Orders表验证
```sql
SELECT * FROM orders WHERE user_id = 'test-user-123' ORDER BY created_at DESC LIMIT 1;
```
预期结果:
- `status` = 'paid'
- `amount_cents` = 2900
- `product_type` = 'package'
- `package_id` = 'package-basic-001'
- `paid_at` 不为空

#### 3.2 UserPackage表验证
```sql
SELECT * FROM user_packages WHERE user_id = 'test-user-123' AND is_active = true;
```
预期结果:
- `package_id` = 'package-basic-001'
- `daily_points` = 10000
- `is_active` = true
- `start_at` = 当前时间
- `end_at` = 当前时间 + 30天
- `package_snapshot` 包含套餐快照信息

#### 3.3 Wallet表验证
```sql
SELECT * FROM wallets WHERE user_id = 'test-user-123';
```
预期结果:
- `package_tokens_remaining` = 10000（每日积分）
- `package_daily_quota_tokens` = 10000
- `package_reset_at` = 明天凌晨时间

#### 3.4 CreditTransaction表验证
```sql
SELECT * FROM credit_transactions
WHERE user_id = 'test-user-123' AND type = 'purchase'
ORDER BY created_at DESC LIMIT 1;
```
预期结果:
- `type` = 'purchase'
- `bucket` = 'package'
- `tokens` = 10000
- `points` = 10000
- `order_id` 对应创建的订单ID

#### 3.5 Dashboard页面验证

**Credits Balance卡片显示:**
- 套餐积分: 10,000
- 独立积分: 0
- 总积分: 10,000

**Current Plan信息显示:**
- 套餐名称: "基础版"
- 剩余天数: 30天
- 每日积分: 10,000

## 测试场景2: 用户升级套餐

### 2.1 测试数据准备
```sql
-- 当前用户已有基础版套餐，剩余15天
-- 升级到专业版套餐
目标套餐ID: package-pro-001
目标套餐名称: "专业版"
价格: 5900分（59.00元）
每日积分: 30000
有效天数: 30
```

### 2.2 测试步骤
1. **用户选择专业版套餐**
   - 系统检测到升级操作
   - 按钮显示为"Upgrade"
   - 计算升级优惠

2. **用户确认升级**
   - 显示原价格、优惠金额、最终价格
   - 确认购买后处理订单

### 2.3 预期结果验证

#### 3.1 UserPackage表更新
```sql
-- 旧套餐被停用
SELECT * FROM user_packages
WHERE user_id = 'test-user-123' AND package_id = 'package-basic-001';
```
预期结果: `is_active` = false

```sql
-- 新套餐被激活
SELECT * FROM user_packages
WHERE user_id = 'test-user-123' AND package_id = 'package-pro-001' AND is_active = true;
```
预期结果: 新的激活套餐记录

#### 3.2 Wallet表更新
```sql
SELECT * FROM wallets WHERE user_id = 'test-user-123';
```
预期结果:
- `package_tokens_remaining` = 30000（新套餐的每日积分）
- `package_daily_quota_tokens` = 30000

## 测试场景3: 用户续费套餐

### 3.1 测试数据准备
```sql
-- 用户当前套餐即将到期（剩余3天）
-- 选择续费同一套餐
续费月数: 1个月
```

### 3.2 测试步骤
1. **用户点击"Renew"按钮**
   - 弹出续费模态框
   - 选择续费月数（1、3、6、12个月）

2. **用户确认续费**
   - 调用 `/api/packages/renew` 接口

### 3.3 预期结果验证

#### 3.1 UserPackage表更新
```sql
SELECT * FROM user_packages
WHERE user_id = 'test-user-123' AND is_active = true;
```
预期结果:
- `end_at` 时间延长1个月
- 其他字段保持不变

## 测试场景4: Dashboard页面实时更新

### 4.1 测试步骤
1. **购买前Dashboard状态**
   - Credits Balance显示: 套餐积分 0，独立积分 X
   - Current Plan显示: "Free Plan"或无套餐信息

2. **购买后页面自动刷新**
   - `fetchPackages()` 函数被调用
   - Dashboard数据通过 `/api/dashboard` 接口更新

### 4.2 预期结果验证

#### 4.1 /api/dashboard 接口返回数据验证
```json
{
  "creditBalance": {
    "packageCredits": 10000,
    "independentCredits": 0,
    "totalCredits": 10000
  },
  "userPackage": {
    "packageName": "基础版",
    "dailyCredits": 10000,
    "endDate": "2024-XX-XX",
    "isActive": true
  },
  "userInfo": {
    "planType": "basic",
    "planExpiredAt": "2024-XX-XX",
    "totalCredits": 10000
  }
}
```

#### 4.2 前端组件显示验证
- **IndependentCredits组件**: 显示正确的套餐积分数量
- **VisitsByLocation组件**: Current Plan区域显示套餐信息
- **WorkSummaryChart组件**: 积分消耗图表可正常显示

## 异常场景测试

### 5.1 支付失败场景
**测试步骤:**
1. 模拟支付接口返回失败
2. 验证订单状态为'failed'
3. 验证用户套餐和积分不变

### 5.2 套餐不存在场景
**测试步骤:**
1. 提交不存在的packageId
2. 验证返回错误信息"Package not found"

### 5.3 套餐已停用场景
**测试步骤:**
1. 选择isActive=false的套餐
2. 验证返回错误信息"Package is not active"

## 测试检查清单

### 数据库完整性检查
- [ ] Orders表正确记录订单信息
- [ ] UserPackage表正确关联用户和套餐
- [ ] Wallet表正确更新用户积分余额
- [ ] CreditTransaction表正确记录积分变动流水

### 业务逻辑检查
- [ ] 购买流程正确执行
- [ ] 升级优惠计算正确
- [ ] 续费逻辑正确
- [ ] 每日积分重置机制正常

### UI/UX检查
- [ ] 套餐页面显示正确
- [ ] 购买确认模态框信息准确
- [ ] Dashboard积分显示实时更新
- [ ] 错误信息友好提示

### 性能检查
- [ ] 购买流程响应时间合理
- [ ] 数据库事务正确提交
- [ ] 页面刷新性能良好

## 回归测试建议

1. **每次修改套餐相关代码后**执行完整测试用例
2. **每次数据库schema变更后**重新验证数据结构
3. **每次前端组件更新后**验证显示逻辑
4. **每次支付相关修改后**验证支付流程

## 测试环境配置

### 环境变量
```env
NODE_ENV=development
DATABASE_URL=postgresql://...
DIRECT_URL=postgresql://...
```

### 测试数据
建议使用独立的测试数据库，包含:
- 测试用户数据
- 测试套餐数据
- 清理脚本

### 模拟服务
- Mock支付接口
- Mock邮件发送服务
- Mock第三方API调用

---

**注意事项:**
1. 测试过程中注意数据清理，避免影响其他测试
2. 验证所有异步操作完成后再检查结果
3. 关注测试执行的时间依赖性（如每日重置逻辑）
4. 定期检查测试用例与实际代码的一致性